<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMA - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Mona+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2a9d8f;
            --mint-green: #81b29a;
            --grayish-blue: #3d405b;
            --light-gray: #f4f1de;
            --dark-green: #264653;
            --accent: #e76f51;
            --pending-color: #f39c12;
            --rejected-color: #e74c3c;
            --accepted-color: #2ecc71;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Mona Sans', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #000;
            overflow-x: hidden;
            padding-bottom: 70px;
            position: relative;
        }
        
        .app-header {
            background-color: var(--primary-green);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .app-title .material-icons {
            margin-right: 8px;
        }
        
        .menu-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
        }
        
        .profile-card {
            background-color: white;
            margin: 15px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        
        .profile-header {
            background-color: var(--mint-green);
            padding: 15px;
            display: flex;
            align-items: center;
        }
        
        .profile-pic {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            overflow: hidden;
            border: 3px solid white;
        }
        
        .profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-pic .material-icons {
            font-size: 36px;
            color: var(--grayish-blue);
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .profile-status {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .profile-status .material-icons {
            font-size: 16px;
            margin-right: 5px;
        }
        
        .profile-details {
            padding: 15px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .detail-row .material-icons {
            font-size: 20px;
            margin-right: 10px;
            color: var(--grayish-blue);
        }
        
        .detail-label {
            font-weight: 500;
            margin-right: 10px;
            min-width: 70px;
        }
        
        .detail-value {
            flex: 1;
        }
        
        .edit-profile-btn {
            background: none;
            border: none;
            color: var(--primary-green);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .edit-profile-btn .material-icons {
            font-size: 18px;
            margin-right: 5px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 0 15px;
            margin-top: 20px;
        }
        
        .action-btn {
            background-color: white;
            border: none;
            border-radius: 15px;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .action-btn .material-icons {
            font-size: 28px;
            margin-bottom: 8px;
            color: var(--primary-green);
        }
        
        .action-btn span {
            font-size: 14px;
            font-weight: 500;
            color: var(--grayish-blue);
        }
        
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent);
            color: white;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab .material-icons {
            font-size: 28px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--grayish-blue);
            text-decoration: none;
            padding: 5px;
            transition: all 0.3s ease;
        }
        
        .nav-item.active {
            color: var(--primary-green);
        }
        
        .nav-item .material-icons {
            font-size: 24px;
        }
        
        .nav-item span {
            font-size: 12px;
            margin-top: 2px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 200;
            justify-content: flex-end;
        }
        
        .modal-content {
            background-color: white;
            width: 100%;
            max-height: 80vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--grayish-blue);
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--grayish-blue);
            cursor: pointer;
            font-size: 24px;
        }
        
        .report-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .report-option {
            background-color: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .report-option:active {
            transform: scale(0.98);
        }
        
        .report-option .material-icons {
            font-size: 30px;
            margin-right: 15px;
            color: var(--primary-green);
        }
        
        .report-option-content h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .report-option-content p {
            font-size: 14px;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--grayish-blue);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-green);
            outline: none;
            box-shadow: 0 0 0 2px rgba(42, 157, 143, 0.2);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .image-upload-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .image-upload-box {
            flex: 1;
            height: 120px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .image-upload-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-upload-box .material-icons {
            font-size: 30px;
            color: #aaa;
        }
        
        .image-upload-box span {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }
        
        .location-picker {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .location-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .location-option {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .location-option.active {
            background-color: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }
        
        .location-option .material-icons {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .submit-btn {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .submit-btn:active {
            transform: scale(0.98);
        }
        
        .agent-card {
            background-color: white;
            margin: 15px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }
        
        .agent-header {
            background-color: var(--grayish-blue);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .agent-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .agent-title .material-icons {
            margin-right: 8px;
        }
        
        .agent-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: var(--pending-color);
        }
        
        .status-rejected {
            background-color: var(--rejected-color);
        }
        
        .status-accepted {
            background-color: var(--accepted-color);
        }
        
        .agent-content {
            padding: 15px;
        }
        
        .agent-description {
            margin-bottom: 15px;
            color: #666;
        }
        
        .agent-actions {
            display: flex;
            gap: 10px;
        }
        
        .agent-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .agent-btn .material-icons {
            margin-right: 5px;
            font-size: 18px;
        }
        
        .apply-btn {
            background-color: var(--pending-color);
            color: white;
        }
        
        .retry-btn {
            background-color: var(--rejected-color);
            color: white;
        }
        
        .status-btn {
            background-color: var(--accepted-color);
            color: white;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(42, 157, 143, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s ease-in-out infinite;
        }
        
        .loading-text {
            margin-top: 15px;
            font-weight: 500;
            color: var(--grayish-blue);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 400;
            max-width: 80%;
        }
        
        .notification.success {
            background-color: var(--accepted-color);
        }
        
        .notification.error {
            background-color: var(--rejected-color);
        }
        
        .notification.info {
            background-color: var(--primary-green);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .edit-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        
        .edit-profile-content {
            background-color: white;
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .edit-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .edit-profile-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--grayish-blue);
        }
        
        .close-edit-profile {
            background: none;
            border: none;
            color: var(--grayish-blue);
            cursor: pointer;
            font-size: 24px;
        }
        
        .edit-profile-pic-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .edit-profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            overflow: hidden;
            border: 3px solid var(--primary-green);
        }
        
        .edit-profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .edit-profile-pic .material-icons {
            font-size: 40px;
            color: var(--grayish-blue);
        }
        
        .edit-profile-pic-btn {
            background-color: var(--mint-green);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .edit-profile-pic-btn .material-icons {
            font-size: 18px;
            margin-right: 5px;
        }
        
        .edit-profile-pic-btn:hover {
            background-color: var(--primary-green);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .map-container {
            height: 200px;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            position: relative;
        }
        
        .map-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
        }
        
        .map-placeholder .material-icons {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .nic-upload-container {
            margin-bottom: 20px;
        }
        
        .nic-upload-box {
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .nic-upload-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .nic-upload-box .material-icons {
            font-size: 40px;
            color: #aaa;
        }
        
        .nic-upload-box span {
            font-size: 14px;
            color: #aaa;
            margin-top: 5px;
        }
        
        @media (max-width: 480px) {
            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1 class="app-title">
            <span class="material-icons">pets</span>
            EMA
        </h1>
        <button class="menu-btn">
            <span class="material-icons">menu</span>
        </button>
    </div>
    
    <div class="profile-card">
        <div class="profile-header">
            <div class="profile-pic" id="userProfilePic">
                <span class="material-icons">person</span>
            </div>
            <div class="profile-info">
                <div class="profile-name" id="userName">Loading...</div>
                <div class="profile-status">
                    <span class="material-icons">verified_user</span>
                    <span>Registered User</span>
                </div>
            </div>
        </div>
        <div class="profile-details">
            <div class="detail-row">
                <span class="material-icons">phone</span>
                <span class="detail-label">Phone:</span>
                <span class="detail-value" id="userPhone">Loading...</span>
            </div>
            <div class="detail-row">
                <span class="material-icons">badge</span>
                <span class="detail-label">NIC:</span>
                <span class="detail-value" id="userNIC">Loading...</span>
            </div>
            <div class="detail-row">
                <span class="material-icons">email</span>
                <span class="detail-label">Email:</span>
                <span class="detail-value" id="userEmail">Loading...</span>
            </div>
            <div class="detail-row">
                <span class="material-icons">location_on</span>
                <span class="detail-label">Location:</span>
                <span class="detail-value" id="userLocation">Loading...</span>
            </div>
            <button class="edit-profile-btn" id="editProfileBtn">
                <span class="material-icons">edit</span>
                Edit Profile
            </button>
        </div>
    </div>
    
    <div class="agent-card" id="agentCard">
        <div class="agent-header">
            <div class="agent-title">
                <span class="material-icons">assignment_ind</span>
                Agent Status
            </div>
            <div class="agent-status" id="agentStatus">Pending</div>
        </div>
        <div class="agent-content">
            <div class="agent-description" id="agentDescription">
                Your agent application is currently being reviewed.
            </div>
            <div class="agent-actions">
                <button class="agent-btn apply-btn" id="applyAgentBtn">
                    <span class="material-icons">how_to_reg</span>
                    Apply as Agent
                </button>
                <button class="agent-btn retry-btn" id="retryAgentBtn" style="display: none;">
                    <span class="material-icons">refresh</span>
                    Retry Application
                </button>
                <button class="agent-btn status-btn" id="viewAgentBtn" style="display: none;">
                    <span class="material-icons">visibility</span>
                    View Agent Status
                </button>
            </div>
        </div>
    </div>
    
    <div class="action-buttons">
        <button class="action-btn" onclick="window.location.href='alerts.html'">
            <span class="material-icons">notifications</span>
            <span>Alerts</span>
        </button>
        <button class="action-btn" onclick="window.location.href='map.html'">
            <span class="material-icons">map</span>
            <span>Map</span>
        </button>
        <button class="action-btn" onclick="window.location.href='ai.html'">
            <span class="material-icons">psychology</span>
            <span>AI</span>
        </button>
        <button class="action-btn" onclick="window.location.href='ana.html'">
            <span class="material-icons">analytics</span>
            <span>Analytics</span>
        </button>
        <button class="action-btn" onclick="window.location.href='status.html'">
            <span class="material-icons">info</span>
            <span>Status</span>
        </button>
        <button class="action-btn" onclick="window.location.href='crops.html'">
            <span class="material-icons">grass</span>
            <span>Crops</span>
        </button>
    </div>
    
    <button class="fab" id="fabBtn">
        <span class="material-icons">add</span>
    </button>
    
    <div class="bottom-nav">
        <a href="#" class="nav-item active">
            <span class="material-icons">home</span>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">search</span>
            <span>Search</span>
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">bookmark</span>
            <span>Saved</span>
        </a>
        <a href="#" class="nav-item">
            <span class="material-icons">person</span>
            <span>Profile</span>
        </a>
    </div>
    
    <!-- Report Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Report an Incident</h2>
                <button class="close-modal" id="closeReportModal">&times;</button>
            </div>
            
            <div class="report-options">
                <div class="report-option" id="sightingOption">
                    <span class="material-icons">visibility</span>
                    <div class="report-option-content">
                        <h3>Elephant Sighting</h3>
                        <p>Report a recent elephant sighting</p>
                    </div>
                </div>
                <div class="report-option" id="accidentOption">
                    <span class="material-icons">warning</span>
                    <div class="report-option-content">
                        <h3>Elephant/Human Accident</h3>
                        <p>Report an accident involving elephants</p>
                    </div>
                </div>
            </div>
            
            <!-- Sighting Form -->
            <div id="sightingForm" style="display: none;">
                <div class="form-group">
                    <label for="sightingDate">Date of Sighting</label>
                    <input type="date" id="sightingDate" required>
                </div>
                
                <div class="form-group">
                    <label for="sightingTime">Time of Sighting</label>
                    <input type="time" id="sightingTime" required>
                </div>
                
                <div class="form-group">
                    <label for="elephantCount">Number of Elephants</label>
                    <input type="number" id="elephantCount" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="elephantDescription">Description</label>
                    <textarea id="elephantDescription" placeholder="Describe the elephants (age, size, behavior, etc.)"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Upload Images (max 2)</label>
                    <div class="image-upload-container">
                        <div class="image-upload-box" id="sightingImage1">
                            <span class="material-icons">add_photo_alternate</span>
                            <span>Tap to upload</span>
                        </div>
                        <div class="image-upload-box" id="sightingImage2">
                            <span class="material-icons">add_photo_alternate</span>
                            <span>Tap to upload</span>
                        </div>
                    </div>
                    <input type="file" id="sightingImageInput1" accept="image/*" style="display: none;">
                    <input type="file" id="sightingImageInput2" accept="image/*" style="display: none;">
                </div>
                
                <div class="location-picker">
                    <label>Location</label>
                    <div class="location-options">
                        <div class="location-option active" id="currentLocation">
                            <span class="material-icons">my_location</span>
                            <span>Current Location</span>
                        </div>
                        <div class="location-option" id="mapLocation">
                            <span class="material-icons">place</span>
                            <span>Select on Map</span>
                        </div>
                    </div>
                    <div class="map-container" id="mapContainer">
                        <div class="map-placeholder">
                            <span class="material-icons">map</span>
                            <span>Map will be displayed here</span>
                        </div>
                    </div>
                </div>
                
                <button class="submit-btn" id="submitSightingBtn">Submit Sighting Report</button>
            </div>
            
            <!-- Accident Form -->
            <div id="accidentForm" style="display: none;">
                <div class="form-group">
                    <label for="accidentDate">Date of Accident</label>
                    <input type="date" id="accidentDate" required>
                </div>
                
                <div class="form-group">
                    <label for="accidentTime">Time of Accident</label>
                    <input type="time" id="accidentTime" required>
                </div>
                
                <div class="form-group">
                    <label for="accidentType">Type of Accident</label>
                    <select id="accidentType" required>
                        <option value="">Select type</option>
                        <option value="property">Property Damage</option>
                        <option value="crop">Crop Damage</option>
                        <option value="injury">Human Injury</option>
                        <option value="fatal">Fatal Incident</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="accidentDescription">Description</label>
                    <textarea id="accidentDescription" placeholder="Describe the accident in detail"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Upload Images (max 2)</label>
                    <div class="image-upload-container">
                        <div class="image-upload-box" id="accidentImage1">
                            <span class="material-icons">add_photo_alternate</span>
                            <span>Tap to upload</span>
                        </div>
                        <div class="image-upload-box" id="accidentImage2">
                            <span class="material-icons">add_photo_alternate</span>
                            <span>Tap to upload</span>
                        </div>
                    </div>
                    <input type="file" id="accidentImageInput1" accept="image/*" style="display: none;">
                    <input type="file" id="accidentImageInput2" accept="image/*" style="display: none;">
                </div>
                
                <div class="location-picker">
                    <label>Location</label>
                    <div class="location-options">
                        <div class="location-option active" id="accidentCurrentLocation">
                            <span class="material-icons">my_location</span>
                            <span>Current Location</span>
                        </div>
                        <div class="location-option" id="accidentMapLocation">
                            <span class="material-icons">place</span>
                            <span>Select on Map</span>
                        </div>
                    </div>
                    <div class="map-container" id="accidentMapContainer">
                        <div class="map-placeholder">
                            <span class="material-icons">map</span>
                            <span>Map will be displayed here</span>
                        </div>
                    </div>
                </div>
                
                <button class="submit-btn" id="submitAccidentBtn">Submit Accident Report</button>
            </div>
        </div>
    </div>
    
    <!-- Agent Application Modal -->
    <div class="modal" id="agentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Apply as EMA Agent</h2>
                <button class="close-modal" id="closeAgentModal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="agentName">Full Name</label>
                <input type="text" id="agentName" required>
            </div>
            
            <div class="form-group">
                <label for="agentNIC">NIC Number</label>
                <input type="text" id="agentNIC" required>
            </div>
            
            <div class="form-group">
                <label for="agentReason">Reason for Applying</label>
                <textarea id="agentReason" placeholder="Why do you want to become an EMA agent?"></textarea>
            </div>
            
            <div class="form-group">
                <label for="agentExperience">Relevant Experience</label>
                <textarea id="agentExperience" placeholder="Describe any relevant experience with wildlife conservation or similar fields"></textarea>
            </div>
            
            <div class="nic-upload-container">
                <label>Upload Front of NIC</label>
                <div class="nic-upload-box" id="nicFrontUpload">
                    <span class="material-icons">badge</span>
                    <span>Tap to upload NIC front</span>
                </div>
                <input type="file" id="nicFrontInput" accept="image/*" style="display: none;">
            </div>
            
            <button class="submit-btn" id="submitAgentBtn">Submit Application</button>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="edit-profile-modal" id="editProfileModal">
        <div class="edit-profile-content">
            <div class="edit-profile-header">
                <h2 class="edit-profile-title">Edit Profile</h2>
                <button class="close-edit-profile" id="closeEditProfileModal">&times;</button>
            </div>
            
            <div class="edit-profile-pic-container">
                <div class="edit-profile-pic" id="editProfilePicPreview">
                    <span class="material-icons">person</span>
                </div>
                <input type="file" id="editProfilePicInput" accept="image/*" style="display: none;">
                <button class="edit-profile-pic-btn" id="editProfilePicBtn">
                    <span class="material-icons">photo_camera</span>
                    Change Profile Picture
                </button>
            </div>
            
            <div class="form-group">
                <label for="editName">Full Name</label>
                <input type="text" id="editName" required>
            </div>
            
            <div class="form-group">
                <label for="editPhone">Phone Number</label>
                <input type="tel" id="editPhone" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="editProvince">Province</label>
                    <select id="editProvince">
                        <option value="">Select Province</option>
                        <option value="Western">Western</option>
                        <option value="Central">Central</option>
                        <option value="Southern">Southern</option>
                        <option value="Northern">Northern</option>
                        <option value="Eastern">Eastern</option>
                        <option value="North Western">North Western</option>
                        <option value="North Central">North Central</option>
                        <option value="Uva">Uva</option>
                        <option value="Sabaragamuwa">Sabaragamuwa</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editDistrict">District</label>
                    <select id="editDistrict">
                        <option value="">Select District</option>
                    </select>
                </div>
            </div>
            
            <button class="submit-btn" id="saveProfileBtn">Save Changes</button>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Processing...</div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        // Designed and developed by Aveesha Ninsara. Copyright Prohibited
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtIvVHA0Q_iuTIFNanoU8RhV4oC60L_YM",
            authDomain: "emausers-9837a.firebaseapp.com",
            projectId: "emausers-9837a",
            storageBucket: "emausers-9837a.firebasestorage.app",
            messagingSenderId: "418180372006",
            appId: "1:418180372006:web:5534a07888222cdb0a78e7",
            measurementId: "G-TRDREJFMQ9",
            databaseURL: "https://emausers-9837a-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Sri Lanka districts by province
        const districtsByProvince = {
            "Western": ["Colombo", "Gampaha", "Kalutara"],
            "Central": ["Kandy", "Matale", "Nuwara Eliya"],
            "Southern": ["Galle", "Matara", "Hambantota"],
            "Northern": ["Jaffna", "Kilinochchi", "Mannar", "Vavuniya", "Mullaitivu"],
            "Eastern": ["Batticaloa", "Ampara", "Trincomalee"],
            "North Western": ["Kurunegala", "Puttalam"],
            "North Central": ["Anuradhapura", "Polonnaruwa"],
            "Uva": ["Badulla", "Monaragala"],
            "Sabaragamuwa": ["Ratnapura", "Kegalle"]
        };
        
        // DOM elements
        const userProfilePic = document.getElementById('userProfilePic');
        const userName = document.getElementById('userName');
        const userPhone = document.getElementById('userPhone');
        const userNIC = document.getElementById('userNIC');
        const userEmail = document.getElementById('userEmail');
        const userLocation = document.getElementById('userLocation');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const agentCard = document.getElementById('agentCard');
        const agentStatus = document.getElementById('agentStatus');
        const agentDescription = document.getElementById('agentDescription');
        const applyAgentBtn = document.getElementById('applyAgentBtn');
        const retryAgentBtn = document.getElementById('retryAgentBtn');
        const viewAgentBtn = document.getElementById('viewAgentBtn');
        const fabBtn = document.getElementById('fabBtn');
        const reportModal = document.getElementById('reportModal');
        const closeReportModal = document.getElementById('closeReportModal');
        const sightingOption = document.getElementById('sightingOption');
        const accidentOption = document.getElementById('accidentOption');
        const sightingForm = document.getElementById('sightingForm');
        const accidentForm = document.getElementById('accidentForm');
        const currentLocation = document.getElementById('currentLocation');
        const mapLocation = document.getElementById('mapLocation');
        const mapContainer = document.getElementById('mapContainer');
        const accidentCurrentLocation = document.getElementById('accidentCurrentLocation');
        const accidentMapLocation = document.getElementById('accidentMapLocation');
        const accidentMapContainer = document.getElementById('accidentMapContainer');
        const sightingImage1 = document.getElementById('sightingImage1');
        const sightingImage2 = document.getElementById('sightingImage2');
        const sightingImageInput1 = document.getElementById('sightingImageInput1');
        const sightingImageInput2 = document.getElementById('sightingImageInput2');
        const accidentImage1 = document.getElementById('accidentImage1');
        const accidentImage2 = document.getElementById('accidentImage2');
        const accidentImageInput1 = document.getElementById('accidentImageInput1');
        const accidentImageInput2 = document.getElementById('accidentImageInput2');
        const submitSightingBtn = document.getElementById('submitSightingBtn');
        const submitAccidentBtn = document.getElementById('submitAccidentBtn');
        const agentModal = document.getElementById('agentModal');
        const closeAgentModal = document.getElementById('closeAgentModal');
        const submitAgentBtn = document.getElementById('submitAgentBtn');
        const nicFrontUpload = document.getElementById('nicFrontUpload');
        const nicFrontInput = document.getElementById('nicFrontInput');
        const editProfileModal = document.getElementById('editProfileModal');
        const closeEditProfileModal = document.getElementById('closeEditProfileModal');
        const editProfilePicPreview = document.getElementById('editProfilePicPreview');
        const editProfilePicInput = document.getElementById('editProfilePicInput');
        const editProfilePicBtn = document.getElementById('editProfilePicBtn');
        const editName = document.getElementById('editName');
        const editPhone = document.getElementById('editPhone');
        const editProvince = document.getElementById('editProvince');
        const editDistrict = document.getElementById('editDistrict');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');
        const notification = document.getElementById('notification');
        
        // Variables
        let currentUserData = null;
        let sightingImage1Base64 = '';
        let sightingImage2Base64 = '';
        let accidentImage1Base64 = '';
        let accidentImage2Base64 = '';
        let nicFrontBase64 = '';
        let editProfilePicBase64 = '';
        let sightingLocation = { lat: null, lng: null };
        let accidentLocation = { lat: null, lng: null };
        let useCurrentLocationForSighting = true;
        let useCurrentLocationForAccident = true;
        
        // Check if user is logged in
        window.addEventListener('load', () => {
            const userEmail = localStorage.getItem('emaUserEmail');
            if (!userEmail) {
                window.location.href = 'index.html';
            } else {
                loadUserData(userEmail);
            }
        });
        
        // Load user data from Firebase
        function loadUserData(email) {
            showLoading('Loading your profile...');
            
            database.ref('users').orderByChild('email').equalTo(email).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const userKey = Object.keys(userData)[0];
                        currentUserData = userData[userKey];
                        currentUserData.key = userKey;
                        
                        // Update UI with user data
                        userName.textContent = currentUserData.name || 'N/A';
                        userPhone.textContent = currentUserData.phone || 'N/A';
                        userNIC.textContent = currentUserData.nic || 'N/A';
                        userEmail.textContent = currentUserData.email || 'N/A';
                        
                        if (currentUserData.province && currentUserData.district) {
                            userLocation.textContent = `${currentUserData.district}, ${currentUserData.province}`;
                        } else {
                            userLocation.textContent = 'N/A';
                        }
                        
                        if (currentUserData.profilePicture) {
                            userProfilePic.innerHTML = `<img src="${currentUserData.profilePicture}" alt="Profile">`;
                        }
                        
                        // Check agent status
                        checkAgentStatus();
                        
                        hideLoading();
                    } else {
                        hideLoading();
                        showNotification('User data not found', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    }
                })
                .catch((error) => {
                    hideLoading();
                    showNotification('Error loading user data: ' + error.message, 'error');
                });
        }
        
        // Check agent status
        function checkAgentStatus() {
            if (currentUserData && currentUserData.agentinfo && currentUserData.agentinfo.dat) {
                const agentInfo = currentUserData.agentinfo.dat;
                const status = agentInfo.agentStatus || 'X';
                
                agentCard.style.display = 'block';
                agentStatus.textContent = status === 'X' ? 'Pending' : (status === 'C' ? 'Rejected' : 'Accepted');
                
                if (status === 'X') {
                    agentStatus.className = 'agent-status status-pending';
                    agentDescription.textContent = 'Your agent application is currently being reviewed.';
                    applyAgentBtn.style.display = 'none';
                    retryAgentBtn.style.display = 'none';
                    viewAgentBtn.style.display = 'none';
                } else if (status === 'C') {
                    agentStatus.className = 'agent-status status-rejected';
                    agentDescription.textContent = 'Your agent application has been rejected. You can apply again.';
                    applyAgentBtn.style.display = 'none';
                    retryAgentBtn.style.display = 'flex';
                    viewAgentBtn.style.display = 'none';
                } else if (status === 'A') {
                    agentStatus.className = 'agent-status status-accepted';
                    agentDescription.textContent = 'Congratulations! You are now an EMA agent.';
                    applyAgentBtn.style.display = 'none';
                    retryAgentBtn.style.display = 'none';
                    viewAgentBtn.style.display = 'flex';
                }
            } else {
                // No agent application yet
                agentCard.style.display = 'block';
                agentStatus.textContent = 'Not Applied';
                agentStatus.className = 'agent-status';
                agentDescription.textContent = 'Apply to become an EMA agent and help protect elephants.';
                applyAgentBtn.style.display = 'flex';
                retryAgentBtn.style.display = 'none';
                viewAgentBtn.style.display = 'none';
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Show loading overlay
        function showLoading(text) {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        }
        
        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        // Compress image to base64
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions to keep aspect ratio but reduce size
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 800;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = height * (maxSize / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = width * (maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Try to get base64 under 20KB by adjusting quality
                    let quality = 0.7;
                    let base64 = canvas.toDataURL('image/jpeg', quality);
                    
                    while (base64.length > 20000 && quality > 0.1) {
                        quality -= 0.1;
                        base64 = canvas.toDataURL('image/jpeg', quality);
                    }
                    
                    callback(base64);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Get current location
        function getCurrentLocation(callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        callback({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        showNotification('Unable to get your current location', 'error');
                        callback(null);
                    }
                );
            } else {
                showNotification('Geolocation is not supported by your browser', 'error');
                callback(null);
            }
        }
        
        // Event Listeners
        
        // FAB button
        fabBtn.addEventListener('click', () => {
            reportModal.style.display = 'flex';
        });
        
        // Close report modal
        closeReportModal.addEventListener('click', () => {
            reportModal.style.display = 'none';
        });
        
        // Report options
        sightingOption.addEventListener('click', () => {
            sightingForm.style.display = 'block';
            accidentForm.style.display = 'none';
        });
        
        accidentOption.addEventListener('click', () => {
            accidentForm.style.display = 'block';
            sightingForm.style.display = 'none';
        });
        
        // Location options for sighting
        currentLocation.addEventListener('click', () => {
            currentLocation.classList.add('active');
            mapLocation.classList.remove('active');
            mapContainer.style.display = 'none';
            useCurrentLocationForSighting = true;
            
            // Get current location
            getCurrentLocation((location) => {
                if (location) {
                    sightingLocation = location;
                }
            });
        });
        
        mapLocation.addEventListener('click', () => {
            mapLocation.classList.add('active');
            currentLocation.classList.remove('active');
            mapContainer.style.display = 'block';
            useCurrentLocationForSighting = false;
            
            // In a real app, you would initialize a map here
            showNotification('Map functionality would be implemented here', 'info');
        });
        
        // Location options for accident
        accidentCurrentLocation.addEventListener('click', () => {
            accidentCurrentLocation.classList.add('active');
            accidentMapLocation.classList.remove('active');
            accidentMapContainer.style.display = 'none';
            useCurrentLocationForAccident = true;
            
            // Get current location
            getCurrentLocation((location) => {
                if (location) {
                    accidentLocation = location;
                }
            });
        });
        
        accidentMapLocation.addEventListener('click', () => {
            accidentMapLocation.classList.add('active');
            accidentCurrentLocation.classList.remove('active');
            accidentMapContainer.style.display = 'block';
            useCurrentLocationForAccident = false;
            
            // In a real app, you would initialize a map here
            showNotification('Map functionality would be implemented here', 'info');
        });
        
        // Image upload for sighting
        sightingImage1.addEventListener('click', () => {
            sightingImageInput1.click();
        });
        
        sightingImageInput1.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file, (base64) => {
                    sightingImage1Base64 = base64;
                    sightingImage1.innerHTML = `<img src="${base64}" alt="Sighting Image 1">`;
                });
            }
        });
        
        sightingImage2.addEventListener('click', () => {
            sightingImageInput2.click();
        });
        
        sightingImageInput2.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file, (base64) => {
                    sightingImage2Base64 = base64;
                    sightingImage2.innerHTML = `<img src="${base64}" alt="Sighting Image 2">`;
                });
            }
        });
        
        // Image upload for accident
        accidentImage1.addEventListener('click', () => {
            accidentImageInput1.click();
        });
        
        accidentImageInput1.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file, (base64) => {
                    accidentImage1Base64 = base64;
                    accidentImage1.innerHTML = `<img src="${base64}" alt="Accident Image 1">`;
                });
            }
        });
        
        accidentImage2.addEventListener('click', () => {
            accidentImageInput2.click();
        });
        
        accidentImageInput2.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file, (base64) => {
                    accidentImage2Base64 = base64;
                    accidentImage2.innerHTML = `<img src="${base64}" alt="Accident Image 2">`;
                });
            }
        });
        
        // Submit sighting report
        submitSightingBtn.addEventListener('click', () => {
            const date = document.getElementById('sightingDate').value;
            const time = document.getElementById('sightingTime').value;
            const count = document.getElementById('elephantCount').value;
            const description = document.getElementById('elephantDescription').value;
            
            if (!date || !time || !count) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (useCurrentLocationForSighting && !sightingLocation.lat) {
                showNotification('Getting your location...', 'info');
                getCurrentLocation((location) => {
                    if (location) {
                        sightingLocation = location;
                        submitSightingReport(date, time, count, description);
                    } else {
                        showNotification('Unable to get your location. Please try again or select location on map', 'error');
                    }
                });
            } else {
                submitSightingReport(date, time, count, description);
            }
        });
        
        function submitSightingReport(date, time, count, description) {
            showLoading('Submitting your sighting report...');
            
            // Generate a unique key for this report
            const reportKey = database.ref().child('sightings').push().key;
            
            // Create report object
            const report = {
                date,
                time,
                count: parseInt(count),
                description,
                image1: sightingImage1Base64,
                image2: sightingImage2Base64,
                location: sightingLocation,
                reportedBy: currentUserData.email,
                reportedByName: currentUserData.name,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save report to Firebase
            database.ref('sightings/' + reportKey).set(report)
                .then(() => {
                    // Add report key to user's reports
                    const userReportsRef = database.ref('users/' + currentUserData.key + '/reports');
                    
                    // Get current reports count
                    userReportsRef.once('value')
                        .then((snapshot) => {
                            const reports = snapshot.val() || {};
                            const newReportCount = (reports.count || 0) + 1;
                            
                            // Update reports count and add this report key
                            reports.count = newReportCount;
                            if (!reports.sightings) {
                                reports.sightings = [];
                            }
                            reports.sightings.push(reportKey);
                            
                            return userReportsRef.set(reports);
                        })
                        .then(() => {
                            hideLoading();
                            showNotification('Sighting report submitted successfully!', 'success');
                            
                            // Reset form
                            document.getElementById('sightingDate').value = '';
                            document.getElementById('sightingTime').value = '';
                            document.getElementById('elephantCount').value = '';
                            document.getElementById('elephantDescription').value = '';
                            sightingImage1Base64 = '';
                            sightingImage2Base64 = '';
                            sightingImage1.innerHTML = '<span class="material-icons">add_photo_alternate</span><span>Tap to upload</span>';
                            sightingImage2.innerHTML = '<span class="material-icons">add_photo_alternate</span><span>Tap to upload</span>';
                            
                            // Close modal
                            reportModal.style.display = 'none';
                        })
                        .catch((error) => {
                            hideLoading();
                            showNotification('Error updating your reports: ' + error.message, 'error');
                        });
                })
                .catch((error) => {
                    hideLoading();
                    showNotification('Error submitting report: ' + error.message, 'error');
                });
        }
        
        // Submit accident report
        submitAccidentBtn.addEventListener('click', () => {
            const date = document.getElementById('accidentDate').value;
            const time = document.getElementById('accidentTime').value;
            const type = document.getElementById('accidentType').value;
            const description = document.getElementById('accidentDescription').value;
            
            if (!date || !time || !type) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (useCurrentLocationForAccident && !accidentLocation.lat) {
                showNotification('Getting your location...', 'info');
                getCurrentLocation((location) => {
                    if (location) {
                        accidentLocation = location;
                        submitAccidentReport(date, time, type, description);
                    } else {
                        showNotification('Unable to get your location. Please try again or select location on map', 'error');
                    }
                });
            } else {
                submitAccidentReport(date, time, type, description);
            }
        });
        
        function submitAccidentReport(date, time, type, description) {
            showLoading('Submitting your accident report...');
            
            // Generate a unique key for this report
            const reportKey = database.ref().child('accidents').push().key;
            
            // Create report object
            const report = {
                date,
                time,
                type,
                description,
                image1: accidentImage1Base64,
                image2: accidentImage2Base64,
                location: accidentLocation,
                reportedBy: currentUserData.email,
                reportedByName: currentUserData.name,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save report to Firebase
            database.ref('accidents/' + reportKey).set(report)
                .then(() => {
                    // Add report key to user's reports
                    const userReportsRef = database.ref('users/' + currentUserData.key + '/reports');
                    
                    // Get current reports count
                    userReportsRef.once('value')
                        .then((snapshot) => {
                            const reports = snapshot.val() || {};
                            const newReportCount = (reports.count || 0) + 1;
                            
                            // Update reports count and add this report key
                            reports.count = newReportCount;
                            if (!reports.accidents) {
                                reports.accidents = [];
                            }
                            reports.accidents.push(reportKey);
                            
                            return userReportsRef.set(reports);
                        })
                        .then(() => {
                            hideLoading();
                            showNotification('Accident report submitted successfully!', 'success');
                            
                            // Reset form
                            document.getElementById('accidentDate').value = '';
                            document.getElementById('accidentTime').value = '';
                            document.getElementById('accidentType').value = '';
                            document.getElementById('accidentDescription').value = '';
                            accidentImage1Base64 = '';
                            accidentImage2Base64 = '';
                            accidentImage1.innerHTML = '<span class="material-icons">add_photo_alternate</span><span>Tap to upload</span>';
                            accidentImage2.innerHTML = '<span class="material-icons">add_photo_alternate</span><span>Tap to upload</span>';
                            
                            // Close modal
                            reportModal.style.display = 'none';
                        })
                        .catch((error) => {
                            hideLoading();
                            showNotification('Error updating your reports: ' + error.message, 'error');
                        });
                })
                .catch((error) => {
                    hideLoading();
                    showNotification('Error submitting report: ' + error.message, 'error');
                });
        }
        
        // Agent application
        applyAgentBtn.addEventListener('click', () => {
            agentModal.style.display = 'flex';
        });
        
        retryAgentBtn.addEventListener('click', () => {
            agentModal.style.display = 'flex';
        });
        
        viewAgentBtn.addEventListener('click', () => {
            window.location.href = 'agent.html';
        });
        
        closeAgentModal.addEventListener('click', () => {
            agentModal.style.display = 'none';
        });
        
        // NIC front upload
        nicFrontUpload.addEventListener('click', () => {
            nicFrontInput.click();
        });
        
        nicFrontInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file, (base64) => {
                    nicFrontBase64 = base64;
                    nicFrontUpload.innerHTML = `<img src="${base64}" alt="NIC Front">`;
                });
            }
        });
        
        // Submit agent application
        submitAgentBtn.addEventListener('click', () => {
            const name = document.getElementById('agentName').value;
            const nic = document.getElementById('agentNIC').value;
            const reason = document.getElementById('agentReason').value;
            const experience = document.getElementById('agentExperience').value;
            
            if (!name || !nic || !nicFrontBase64) {
                showNotification('Please fill in all required fields and upload your NIC', 'error');
                return;
            }
            
            showLoading('Submitting your agent application...');
            
            // Create agent application object
            const agentApplication = {
                name,
                nic,
                reason,
                experience,
                nicFront: nicFrontBase64,
                agentStatus: 'X', // X for pending
                appliedDate: firebase.database.ServerValue.TIMESTAMP
            };
            
            // Save agent application to Firebase
            database.ref('users/' + currentUserData.key + '/agentinfo/dat').set(agentApplication)
                .then(() => {
                    hideLoading();
                    showNotification('Agent application submitted successfully!', 'success');
                    
                    // Reset form
                    document.getElementById('agentName').value = '';
                    document.getElementById('agentNIC').value = '';
                    document.getElementById('agentReason').value = '';
                    document.getElementById('agentExperience').value = '';
                    nicFrontBase64 = '';
                    nicFrontUpload.innerHTML = '<span class="material-icons">badge</span><span>Tap to upload NIC front</span>';
                    
                    // Update agent status in UI
                    currentUserData.agentinfo = { dat: agentApplication };
                    checkAgentStatus();
                    
                    // Close modal
                    agentModal.style.display = 'none';
                })
                .catch((error) => {
                    hideLoading();
                    showNotification('Error submitting application: ' + error.message, 'error');
                });
        });
        
        // Edit profile
        editProfileBtn.addEventListener('click', () => {
            // Pre-fill form with current data
            editName.value = currentUserData.name || '';
            editPhone.value = currentUserData.phone || '';
            editProvince.value = currentUserData.province || '';
            
            // Update district options based on province
            updateDistrictOptions(editDistrict, currentUserData.province);
            editDistrict.value = currentUserData.district || '';
            
            // Set profile picture
            if (currentUserData.profilePicture) {
                editProfilePicPreview.innerHTML = `<img src="${currentUserData.profilePicture}" alt="Profile">`;
                editProfilePicBase64 = currentUserData.profilePicture;
            }
            
            editProfileModal.style.display = 'flex';
        });
        
        closeEditProfileModal.addEventListener('click', () => {
            editProfileModal.style.display = 'none';
        });
        
        // Profile picture upload
        editProfilePicBtn.addEventListener('click', () => {
            editProfilePicInput.click();
        });
        
        editProfilePicInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file, (base64) => {
                    editProfilePicBase64 = base64;
                    editProfilePicPreview.innerHTML = `<img src="${base64}" alt="Profile">`;
                });
            }
        });
        
        // Update district options based on province
        function updateDistrictOptions(districtSelect, province) {
            districtSelect.innerHTML = '<option value="">Select District</option>';
            
            if (province && districtsByProvince[province]) {
                districtsByProvince[province].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }
        
        // Province change handler
        editProvince.addEventListener('change', () => {
            updateDistrictOptions(editDistrict, editProvince.value);
        });
        
        // Save profile changes
        saveProfileBtn.addEventListener('click', () => {
            const name = editName.value;
            const phone = editPhone.value;
            const province = editProvince.value;
            const district = editDistrict.value;
            
            if (!name || !phone || !province || !district) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            showLoading('Updating your profile...');
            
            // Update user data
            const updates = {
                name,
                phone,
                province,
                district
            };
            
            // Update profile picture if changed
            if (editProfilePicBase64 && editProfilePicBase64 !== currentUserData.profilePicture) {
                updates.profilePicture = editProfilePicBase64;
            }
            
            database.ref('users/' + currentUserData.key).update(updates)
                .then(() => {
                    hideLoading();
                    showNotification('Profile updated successfully!', 'success');
                    
                    // Update current user data
                    Object.assign(currentUserData, updates);
                    
                    // Update UI
                    userName.textContent = name;
                    userPhone.textContent = phone;
                    userLocation.textContent = `${district}, ${province}`;
                    
                    if (updates.profilePicture) {
                        userProfilePic.innerHTML = `<img src="${updates.profilePicture}" alt="Profile">`;
                    }
                    
                    // Close modal
                    editProfileModal.style.display = 'none';
                })
                .catch((error) => {
                    hideLoading();
                    showNotification('Error updating profile: ' + error.message, 'error');
                });
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === reportModal) {
                reportModal.style.display = 'none';
            }
            if (e.target === agentModal) {
                agentModal.style.display = 'none';
            }
            if (e.target === editProfileModal) {
                editProfileModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
