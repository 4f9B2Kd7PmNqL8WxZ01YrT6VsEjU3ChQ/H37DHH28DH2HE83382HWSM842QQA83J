<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA - Elephant Monitoring App</title>

    <link rel="stylesheet" href="https://fonts.cdnfonts.com/css/mona-sans" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --green: #42a75a;
            --green-strong: #2f8a45;
            --muted: #7a7a7a;
            --card-radius: 20px;
            --glass: rgba(255,255,255,0.92);
            --background-light: #f5f7f5;
            --blue: #4285F4;
            --red: #EA4335;
            --yellow: #FBBC05;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Mona Sans", "Inter", "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        body {
            background: var(--background-light);
        }

        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .user-pill-container {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        .user-pill {
            background: var(--glass);
            border-radius: 50px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(6px) saturate(110%);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            position: relative;
        }

        .user-avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .user-avatar:hover .user-avatar-overlay {
            opacity: 1;
        }

        .user-avatar-overlay .material-symbols-outlined {
            color: white;
            font-size: 18px;
        }

        .user-info {
            flex: 1;
            padding: 0 8px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin: 0;
        }

        .user-ema-id {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        .edit-icon, .stats-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .edit-icon {
            background: var(--green);
        }
        .edit-icon:hover {
            background: var(--green-strong);
        }

        .stats-icon {
            background: var(--blue);
        }
        .stats-icon:hover {
            background: #3367D6;
        }

        .map-toggle {
            position: absolute;
            top: 25px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(6px) saturate(110%);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .map-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .map-toggle .material-symbols-outlined {
            font-size: 24px;
            color: var(--green);
        }

        .user-location-btn {
            position: absolute;
            bottom: 25px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(6px) saturate(110%);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .user-location-btn .material-symbols-outlined {
            font-size: 24px;
            color: var(--blue);
        }

        .info-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--glass);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(6px) saturate(110%);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .info-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .info-btn .material-symbols-outlined {
            font-size: 24px;
            color: var(--muted);
        }

        .other-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass);
            border-radius: 50px;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(6px) saturate(110%);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .other-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .modal.active { display: flex; }

        .modal-card {
            background: white;
            border-radius: var(--card-radius);
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
            font-family: "Mona Sans", "Inter", "Helvetica Neue", Arial, sans-serif;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .close-modal {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .close-modal:hover { background: #e0e0e0; }
        .close-modal .material-symbols-outlined { font-size: 18px; color: #555; }

        /* Form Elements */
        .field { position: relative; margin-bottom: 16px; }
        .field label { display: block; font-size: 13px; color: #555; margin-bottom: 6px; font-weight: 600; }

        .input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid #e6e6e6;
            background: #fff;
            font-size: 15px;
            outline: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .input input, .input select {
            border: 0; outline: 0; font-size: 15px; flex: 1; background: transparent;
        }
        .input select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .input .material-symbols-outlined { font-size: 18px; color: var(--muted); }

        .error-text { color: #D32F2F; font-size: 12px; margin-top: 4px; display: none; }

        .btn {
            display: inline-block;
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            background: var(--green);
            color: white;
            border: none;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-top: 8px;
            box-shadow: 0 6px 18px rgba(66,167,90,0.16);
            transition: all 0.2s ease;
        }
        .btn:hover { background: var(--green-strong); }
        .btn:disabled { background: #BDBDBD; cursor: not-allowed; }
        .btn-danger { background: var(--red); }
        .btn-danger:hover { background: #D32F2F; }

        /* Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .loader {
            border: 4px solid rgba(66, 167, 90, 0.1);
            border-top: 4px solid var(--green);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { font-size: 16px; color: var(--green); font-weight: 600; }

        /* Report Form */
        .report-form-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 3000;
            display: none;
            flex-direction: column;
        }
        .report-form-container.active { display: flex; }
        .report-form-header {
            padding: 20px;
            background: var(--green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .report-form-title { font-size: 20px; font-weight: 600; }
        .report-form-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .report-form-close:hover { background: rgba(255,255,255,0.3); }
        .report-form-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: calc(100vh - 80px);
        }
        .report-slide { display: none; height: 100%; }
        .report-slide.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .report-options { display: flex; flex-direction: column; gap: 20px; height: 100%; }
        .report-option {
            flex: 1;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 24px;
            color: white;
            text-align: center;
            padding: 20px;
            min-height: 150px; /* Made taller */
        }
        .report-option.sighting { background: var(--green); }
        .report-option.accident { background: var(--red); }
        .report-option:hover { transform: scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .report-option i { font-size: 60px; margin-bottom: 15px; }

        .report-question { font-size: 20px; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .radio-options { display: flex; gap: 20px; margin-bottom: 30px; }
        .radio-option {
            flex: 1;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e6e6e6;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 600;
            min-height: 150px; /* Made taller */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .radio-option.selected { border-color: var(--green); background: rgba(66, 167, 90, 0.1); }
        .radio-option i { font-size: 40px; margin-bottom: 10px; color: var(--muted); }
        .radio-option.selected i { color: var(--green); }

        .dial-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .dial-button {
            aspect-ratio: 1;
            border-radius: 15px;
            border: 1px solid #e6e6e6;
            background: white;
            font-size: 28px; /* Larger font */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70px; /* Taller buttons */
        }
        .dial-button:hover { background: #f5f5f5; }
        .dial-button:active { transform: scale(0.95); background: #e6e6e6; }

        .dial-display { font-size: 28px; font-weight: 700; text-align: center; padding: 15px; margin-bottom: 20px; border-radius: 15px; background: #f5f5f5; }
        .dial-actions { display: flex; gap: 15px; }
        .dial-button-action {
            flex: 1;
            padding: 15px;
            border-radius: 15px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 50px;
        }
        .dial-correct { background: var(--green); color: white; }
        .dial-backspace { background: #f5f5f5; }

        .image-upload-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .image-upload-box {
            aspect-ratio: 1;
            border-radius: 15px;
            border: 2px dashed #e6e6e6;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .image-upload-box:hover { border-color: var(--green); background: rgba(66, 167, 90, 0.05); }
        .image-upload-box i { font-size: 40px; color: var(--muted); margin-bottom: 10px; }
        .image-upload-box.has-image { border-style: solid; padding: 0; }
        .image-preview { width: 100%; height: 100%; object-fit: cover; }
        .image-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .text-area {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #e6e6e6;
            font-size: 16px;
            resize: none;
            outline: none;
            font-family: inherit;
        }
        .text-area:focus { border-color: var(--green); }
        .submit-button {
            padding: 18px;
            border-radius: 15px;
            background: var(--green);
            color: white;
            border: none;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 20px;
        }
        .submit-button:hover { background: var(--green-strong); }

        /* Other Modals */
        .welcome-banner, .success-modal, .report-details-modal, .info-modal, .location-error-modal, .logout-modal, .stats-modal, .message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }
        .welcome-banner.active, .success-modal.active, .report-details-modal.active, .info-modal.active, .location-error-modal.active, .logout-modal.active, .stats-modal.active, .message-modal.active {
            display: flex;
        }
        .welcome-card, .success-content, .location-error-content, .logout-content, .message-content {
            background: white;
            border-radius: var(--card-radius);
            padding: 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
        }
        .welcome-emoji { font-size: 60px; margin-bottom: 20px; }
        .welcome-title, .success-title, .location-error-title, .logout-title, .message-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--green);
            margin-bottom: 15px;
        }
        .location-error-title { color: var(--red); }
        .welcome-message, .success-message, .location-error-message, .logout-message, .message-text {
            font-size: 16px;
            color: #555;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .welcome-button, .success-button, .message-button {
            background: var(--green);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .welcome-button:hover, .success-button:hover, .message-button:hover { background: var(--green-strong); }

        .location-error-actions, .logout-actions { display: flex; gap: 15px; }
        .location-error-btn, .logout-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .location-error-retry, .logout-cancel { background: var(--green); color: white; }
        .location-error-settings, .logout-confirm { background: var(--blue); color: white; }
        .logout-confirm.btn-danger { background: var(--red); }

        .report-details-content, .info-content, .stats-content {
            background: white;
            border-radius: var(--card-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            margin: auto;
            animation: slideUp 0.4s ease;
            position: relative;
            overflow-y: auto;
            max-height: 80vh;
        }
        .report-details-header, .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e6e6e6;
        }
        .report-details-title, .stats-title { font-size: 20px; font-weight: 700; color: #333; }
        .report-details-close, .stats-close, .info-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .report-details-close:hover, .stats-close:hover, .info-close:hover { background: #e0e0e0; }
        .report-info, .stats-info { margin-bottom: 20px; }
        .report-info-label, .stats-info-label { font-size: 14px; color: var(--muted); margin-bottom: 5px; }
        .report-info-value, .stats-info-value { font-size: 16px; font-weight: 600; color: #333; }
        .report-images { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .report-image { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 10px; cursor: pointer; }
        .report-actions { display: flex; gap: 15px; margin-top: 20px; }
        .report-action-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .call-btn { background: var(--green); color: white; }
        .download-btn { background: var(--blue); color: white; }

        .info-title { font-size: 24px; font-weight: 700; color: #333; margin-bottom: 20px; text-align: center; }
        .info-section { margin-bottom: 25px; }
        .info-section-title { font-size: 18px; font-weight: 600; color: var(--green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .info-section-title i { font-size: 24px; }
        .info-item-text { font-size: 16px; line-height: 1.5; color: #555; }
        .marker-legend { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .marker-legend-item { display: flex; align-items: center; gap: 8px; }
        .marker-legend-color { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .marker-legend-text { font-size: 14px; color: #555; }

        .reports-list { margin-top: 20px; }
        .reports-list-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 15px; }
        .report-item { background: #f9f9f9; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative; }
        .report-item-type { font-weight: 600; margin-bottom: 5px; }
        .report-item-date { font-size: 14px; color: var(--muted); }
        .delete-report-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .delete-report-btn:hover { background: #D32F2F; }

        /* Map Markers */
        .user-location-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4285F4;
            border: 3px solid white;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.3), 0 0 0 6px rgba(66, 133, 244, 0.1);
        }
        .report-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .sighting-marker { background: var(--green); }
        .accident-marker { background: var(--red); }
        .accident-medical-marker { background: var(--yellow); }

        @media (max-width: 768px) {
            .report-options { flex-direction: column; }
            .image-upload-container { grid-template-columns: 1fr; }
            .report-images { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Main Map -->
    <div id="map"></div>

    <!-- Top Controls -->
    <div class="user-pill-container">
        <div class="user-pill" id="userPill">
            <div class="user-avatar-container">
                <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                <div class="user-avatar-overlay">
                    <span class="material-symbols-outlined">camera_alt</span>
                </div>
            </div>
            <div class="user-info">
                <p id="userName" class="user-name">Loading...</p>
                <p id="userEmaId" class="user-ema-id">Loading...</p>
            </div>
        </div>
        <div class="edit-icon" id="editProfileBtn">
            <span class="material-symbols-outlined">edit</span>
        </div>
        <div class="stats-icon" id="statsBtn">
            <span class="material-symbols-outlined">bar_chart</span>
        </div>
    </div>
    <div class="map-toggle" id="mapToggleBtn">
        <span class="material-symbols-outlined">layers</span>
    </div>

    <!-- Bottom Controls -->
    <div class="user-location-btn" id="userLocationBtn">
        <span class="material-symbols-outlined">my_location</span>
    </div>
    <div class="info-btn" id="infoBtn">
        <span class="material-symbols-outlined">info</span>
    </div>
    <div class="other-btn" id="otherBtn">Other</div>

    <!-- Welcome Banner -->
    <div class="welcome-banner" id="welcomeBanner">
        <div class="welcome-card">
            <div class="welcome-emoji">üêòüåç</div>
            <h2 class="welcome-title">Welcome to EMA!</h2>
            <p class="welcome-message">
                This is EMA, Elephant Monitoring App. You can report elephant sightings, see reports from others, avoid fake reports, and help protect these magnificent creatures. Together, we're making a difference for wildlife conservation!
            </p>
            <button class="welcome-button" id="getStartedBtn">Get Started</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-card">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <div class="close-modal" id="closeModalBtn">
                    <span class="material-symbols-outlined">close</span>
                </div>
            </div>
            <form id="editProfileForm">
                <div class="field"><label for="editFullName">Full Name</label>
                    <div class="input"><span class="material-symbols-outlined">person</span><input id="editFullName" type="text" required /></div>
                    <div id="editFullNameError" class="error-text"></div>
                </div>
                <div class="field"><label for="editPhone">Phone Number</label>
                    <div class="input"><span class="material-symbols-outlined">phone</span><input id="editPhone" type="tel" required /></div>
                    <div id="editPhoneError" class="error-text"></div>
                </div>
                <div class="field"><label for="editDistrict">District</label>
                    <div class="input"><span class="material-symbols-outlined">location_on</span>
                        <select id="editDistrict" required>
                            <option value="">Select District</option>
                            <option value="Ampara">Ampara</option><option value="Anuradhapura">Anuradhapura</option><option value="Badulla">Badulla</option>
                            <option value="Batticaloa">Batticaloa</option><option value="Colombo">Colombo</option><option value="Galle">Galle</option>
                            <option value="Gampaha">Gampaha</option><option value="Hambantota">Hambantota</option><option value="Jaffna">Jaffna</option>
                            <option value="Kalutara">Kalutara</option><option value="Kandy">Kandy</option><option value="Kegalle">Kegalle</option>
                            <option value="Kilinochchi">Kilinochchi</option><option value="Kurunegala">Kurunegala</option><option value="Mannar">Mannar</option>
                            <option value="Matale">Matale</option><option value="Matara">Matara</option><option value="Monaragala">Monaragala</option>
                            <option value="Mullaitivu">Mullaitivu</option><option value="Nuwara Eliya">Nuwara Eliya</option><option value="Polonnaruwa">Polonnaruwa</option>
                            <option value="Puttalam">Puttalam</option><option value="Ratnapura">Ratnapura</option><option value="Trincomalee">Trincomalee</option>
                            <option value="Vavuniya">Vavuniya</option>
                        </select>
                    </div>
                    <div id="editDistrictError" class="error-text"></div>
                </div>
                <div class="field"><label for="editEmail">Email</label>
                    <div class="input"><span class="material-symbols-outlined">mail</span><input id="editEmail" type="email" required /></div>
                    <div id="editEmailError" class="error-text"></div>
                </div>
                <button type="button" class="btn" id="agentStatusBtn">Agent Status</button>
                <button type="submit" class="btn" id="saveProfileBtn">Save Changes</button>
                <button type="button" class="btn btn-danger" id="logoutBtn">Log Out</button>
            </form>
        </div>
    </div>

    <!-- Report Form -->
    <div class="report-form-container" id="reportFormContainer">
        <div class="report-form-header">
            <div class="report-form-title" id="reportFormTitle">Report</div>
            <div class="report-form-close" id="reportFormClose">
                <span class="material-symbols-outlined">close</span>
            </div>
        </div>
        <div class="report-form-content">
            <div class="report-slide active" id="reportTypeSlide">
                <div class="report-type-selection">
                    <h2 class="report-type-title">What would you like to report?</h2>
                    <p class="report-type-subtitle">Select one of the options below to continue</p>
                    <div class="report-options">
                        <div class="report-option sighting" id="sightingOption"><i class="fas fa-eye"></i>Elephant Sighting</div>
                        <div class="report-option accident" id="accidentOption"><i class="fas fa-exclamation-triangle"></i>Elephant Accident</div>
                    </div>
                </div>
            </div>
            <div class="report-slide" id="elephantTypeSlide">
                <h3 class="report-question">What did you see?</h3>
                <div class="radio-options">
                    <div class="radio-option" id="elephantOption"><i class="fas fa-elephant"></i>Elephant</div>
                    <div class="radio-option" id="tuskerOption"><i class="fas fa-tusk"></i>Tusker</div>
                </div>
            </div>
            <div class="report-slide" id="countSlide">
                <h3 class="report-question">How many did you see?</h3>
                <div class="dial-display" id="countDisplay">0</div>
                <div class="dial-pad">
                    <div class="dial-button" data-value="1">1</div><div class="dial-button" data-value="2">2</div><div class="dial-button" data-value="3">3</div>
                    <div class="dial-button" data-value="4">4</div><div class="dial-button" data-value="5">5</div><div class="dial-button" data-value="6">6</div>
                    <div class="dial-button" data-value="7">7</div><div class="dial-button" data-value="8">8</div><div class="dial-button" data-value="9">9</div>
                    <div class="dial-button" data-value="*">*</div><div class="dial-button" data-value="0">0</div><div class="dial-button" data-value="#"><span class="material-symbols-outlined">backspace</span></div>
                </div>
                <div class="dial-actions">
                    <div class="dial-button-action dial-backspace" id="countBackspace"><span class="material-symbols-outlined">backspace</span></div>
                    <div class="dial-button-action dial-correct" id="countCorrect">Continue</div>
                </div>
            </div>
            <div class="report-slide" id="imagesSlide">
                <h3 class="report-question">Add images (max 4)</h3>
                <div class="image-upload-container">
                    <div class="image-upload-box" id="imageUpload1"><i class="fas fa-camera"></i><div>Image 1</div></div>
                    <div class="image-upload-box" id="imageUpload2"><i class="fas fa-camera"></i><div>Image 2</div></div>
                    <div class="image-upload-box" id="imageUpload3"><i class="fas fa-camera"></i><div>Image 3</div></div>
                    <div class="image-upload-box" id="imageUpload4"><i class="fas fa-camera"></i><div>Image 4</div></div>
                </div>
                <div class="dial-actions">
                    <div class="dial-button-action dial-correct" id="continueToDescription">Continue</div>
                </div>
            </div>
            <div class="report-slide" id="descriptionSlide">
                <h3 class="report-question">Brief Description</h3>
                <textarea class="text-area" id="reportDescription" placeholder="Describe what you saw..."></textarea>
                <button class="submit-button" id="submitReportBtn">Submit Report</button>
            </div>
            <div class="report-slide" id="injurySlide">
                <h3 class="report-question">Were there any injuries?</h3>
                <div class="radio-options">
                    <div class="radio-option" id="injuredHumansOption"><i class="fas fa-user-injured"></i>Injured Humans</div>
                    <div class="radio-option" id="injuredElephantsOption"><i class="fas fa-elephant-injured"></i>Injured Elephants</div>
                </div>
            </div>
            <div class="report-slide" id="medicalHelpSlide">
                <h3 class="report-question">Is medical help needed?</h3>
                <div class="radio-options">
                    <div class="radio-option" id="medicalYesOption"><i class="fas fa-ambulance"></i>Yes</div>
                    <div class="radio-option" id="medicalNoOption"><i class="fas fa-check-circle"></i>No</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-gif"><img src="https://media.tenor.com/bm8Q6yAlsPsAAAAj/verified.gif" alt="Success" width="150" height="150"></div>
            <h2 class="success-title">Report Submitted!</h2>
            <p class="success-message">Your report has been successfully submitted. Thank you for helping protect elephants!</p>
            <button class="success-button" id="successCloseBtn">Close</button>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="report-details-modal" id="reportDetailsModal">
        <div class="report-details-content">
            <div class="report-details-header">
                <h3 class="report-details-title">Report Details</h3>
                <div class="report-details-close" id="reportDetailsClose"><span class="material-symbols-outlined">close</span></div>
            </div>
            <div class="report-info"><div class="report-info-label">Report Type</div><div class="report-info-value" id="reportTypeValue">-</div></div>
            <div class="report-info"><div class="report-info-label">Date & Time</div><div class="report-info-value" id="reportDateTimeValue">-</div></div>
            <div class="report-info"><div class="report-info-label">Location</div><div class="report-info-value" id="reportLocationValue">-</div></div>
            <div class="report-info"><div class="report-info-label">Elephant Type</div><div class="report-info-value" id="reportElephantTypeValue">-</div></div>
            <div class="report-info"><div class="report-info-label">Count</div><div class="report-info-value" id="reportCountValue">-</div></div>
            <div id="accidentSpecificInfo" style="display: none;">
                <div class="report-info"><div class="report-info-label">Injuries</div><div class="report-info-value" id="reportInjuriesValue">-</div></div>
                <div class="report-info"><div class="report-info-label">Medical Help Needed</div><div class="report-info-value" id="reportMedicalHelpValue">-</div></div>
            </div>
            <div class="report-info"><div class="report-info-label">Description</div><div class="report-info-value" id="reportDescriptionValue">-</div></div>
            <div class="report-info"><div class="report-info-label">Reported By</div><div class="report-info-value" id="reporterNameValue">-</div></div>
            <div class="report-info"><div class="report-info-label">Contact Number</div><div class="report-info-value" id="reporterPhoneValue">-</div></div>
            <div class="report-images" id="reportImagesContainer"></div>
            <div class="report-actions">
                <button class="report-action-btn call-btn" id="callReporterBtn"><i class="fas fa-phone"></i>Call Reporter</button>
                <button class="report-action-btn download-btn" id="downloadImagesBtn"><i class="fas fa-download"></i>Download Images</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-content">
            <div class="info-close" id="closeInfoModalBtn"><span class="material-symbols-outlined">close</span></div>
            <h2 class="info-title">EMA Information</h2>
            <div class="info-section">
                <h3 class="info-section-title"><i class="fas fa-elephant"></i>About EMA</h3>
                <p class="info-item-text">EMA (Elephant Monitoring App) is a community-driven platform for tracking elephant sightings and accidents. It helps protect both elephants and humans by providing real-time information about elephant movements.</p>
            </div>
            <div class="info-section">
                <h3 class="info-section-title"><i class="fas fa-map-marked-alt"></i>Map Markers</h3>
                <div class="marker-legend">
                    <div class="marker-legend-item"><div class="marker-legend-color sighting-marker"></div><div class="marker-legend-text">Elephant Sighting</div></div>
                    <div class="marker-legend-item"><div class="marker-legend-color accident-marker"></div><div class="marker-legend-text">Elephant Accident</div></div>
                    <div class="marker-legend-item"><div class="marker-legend-color accident-medical-marker"></div><div class="marker-legend-text">Accident with Medical Help Needed</div></div>
                </div>
            </div>
            <div class="info-section">
                <h3 class="info-section-title"><i class="fas fa-eye"></i>Report Visibility</h3>
                <p class="info-item-text">Only reports from last 12 hours are visible on map to ensure information is current and relevant. Older reports are archived in database but not displayed on map.</p>
            </div>
            <div class="info-section">
                <h3 class="info-section-title"><i class="fas fa-check-circle"></i>Report Verification</h3>
                <p class="info-item-text">EMA uses a verification system to minimize fake reports. Users can report suspicious sightings, and our team reviews flagged content regularly.</p>
            </div>
        </div>
    </div>

    <!-- Location Error Modal -->
    <div class="location-error-modal" id="locationErrorModal">
        <div class="location-error-content">
            <div class="location-error-icon"><i class="fas fa-location-crosshairs-slash"></i></div>
            <h2 class="location-error-title">Location Access Required</h2>
            <p class="location-error-message">EMA needs access to your location to show reports on map and allow you to report sightings at your current location. Please enable location services and try again.</p>
            <div class="location-error-actions">
                <button class="location-error-btn location-error-retry" id="retryLocationBtn"><i class="fas fa-redo"></i>Retry</button>
                <button class="location-error-btn location-error-settings" id="openSettingsBtn"><i class="fas fa-cog"></i>Open Settings</button>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="logout-modal" id="logoutModal">
        <div class="logout-content">
            <h2 class="logout-title">Log Out Options</h2>
            <p class="logout-message">Choose an option below:</p>
            <div class="logout-actions">
                <button class="logout-btn logout-cancel" id="logoutCancelBtn">Cancel</button>
                <button class="logout-btn logout-confirm" id="logoutConfirmBtn">Log Out</button>
            </div>
            <button class="btn btn-danger" id="deleteAccountBtn">Delete Account and Log Out</button>
        </div>
    </div>

    <!-- User Stats Modal -->
    <div class="stats-modal" id="statsModal">
        <div class="stats-content">
            <div class="stats-header">
                <h3 class="stats-title">User Statistics</h3>
                <div class="stats-close" id="closeStatsModalBtn"><span class="material-symbols-outlined">close</span></div>
            </div>
            <div class="stats-info"><div class="stats-info-label">User Name</div><div class="stats-info-value" id="statsUserName">-</div></div>
            <div class="stats-info"><div class="stats-info-label">EMA ID</div><div class="stats-info-value" id="statsEmaId">-</div></div>
            <div class="stats-info"><div class="stats-info-label">Total Reports</div><div class="stats-info-value" id="statsTotalReports">-</div></div>
            <div class="reports-list">
                <h3 class="reports-list-title">Your Reports</h3>
                <div id="reportsListContainer"></div>
            </div>
        </div>
    </div>

    <!-- Generic Message Modal -->
    <div class="message-modal" id="messageModal">
        <div class="message-content">
            <h2 class="message-title" id="messageTitle">Message</h2>
            <p class="message-text" id="messageText">-</p>
            <button class="message-button" id="messageCloseBtn">OK</button>
        </div>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
    <input type="file" id="reportImageInput1" accept="image/*" style="display: none;">
    <input type="file" id="reportImageInput2" accept="image/*" style="display: none;">
    <input type="file" id="reportImageInput3" accept="image/*" style="display: none;">
    <input type="file" id="reportImageInput4" accept="image/*" style="display: none;">

    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
        <div class="loader-text">Loading your data...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('selectstart', event => event.preventDefault());
        document.addEventListener('dragstart', event => event.preventDefault());

        const firebaseConfig = {
            apiKey: "AIzaSyCtIvVHA0Q_iuTIFNanoU8RhV4oC60L_YM",
            authDomain: "emausers-9837a.firebaseapp.com",
            projectId: "emausers-9837a",
            storageBucket: "emausers-9837a.firebasestorage.app",
            messagingSenderId: "418180372006",
            appId: "1:418180372006:web:5534a07888222cdb0a78e7",
            measurementId: "G-TRDREJFMQ9",
            databaseURL: "https://emausers-9837a-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const welcomeBanner = document.getElementById('welcomeBanner');
        const getStartedBtn = document.getElementById('getStartedBtn');
        const loader = document.getElementById('loader');
        const userPill = document.getElementById('userPill');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userEmaId = document.getElementById('userEmaId');
        const editProfileBtn = document.getElementById('editProfileBtn');
        const editProfileModal = document.getElementById('editProfileModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const editProfileForm = document.getElementById('editProfileForm');
        const mapToggleBtn = document.getElementById('mapToggleBtn');
        const userLocationBtn = document.getElementById('userLocationBtn');
        const infoBtn = document.getElementById('infoBtn');
        const reportFormContainer = document.getElementById('reportFormContainer');
        const reportFormClose = document.getElementById('reportFormClose');
        const successModal = document.getElementById('successModal');
        const successCloseBtn = document.getElementById('successCloseBtn');
        const reportDetailsModal = document.getElementById('reportDetailsModal');
        const reportDetailsClose = document.getElementById('reportDetailsClose');
        const infoModal = document.getElementById('infoModal');
        const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
        const profilePictureInput = document.getElementById('profilePictureInput');
        const agentStatusBtn = document.getElementById('agentStatusBtn');
        const otherBtn = document.getElementById('otherBtn');
        const locationErrorModal = document.getElementById('locationErrorModal');
        const retryLocationBtn = document.getElementById('retryLocationBtn');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutModal = document.getElementById('logoutModal');
        const logoutCancelBtn = document.getElementById('logoutCancelBtn');
        const logoutConfirmBtn = document.getElementById('logoutConfirmBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn');
        const statsBtn = document.getElementById('statsBtn');
        const statsModal = document.getElementById('statsModal');
        const closeStatsModalBtn = document.getElementById('closeStatsModalBtn');
        const messageModal = document.getElementById('messageModal');
        const messageTitle = document.getElementById('messageTitle');
        const messageText = document.getElementById('messageText');
        const messageCloseBtn = document.getElementById('messageCloseBtn');

        // Global Variables
        let map;
        let userLocationMarker;
        let currentMapLayer = 'osm';
        let osmLayer;
        let esriLayer;
        let reportMarkers = [];
        let reportLocationMarker = null;
        let reportLocation = null;
        let userData = null;
        let emaId = null;
        let reportData = {
            type: '', elephantType: '', count: 0, images: [], description: '',
            injuries: [], medicalHelpNeeded: false, location: null, timestamp: null, reporterId: null
        };

        // Initial Setup
        document.addEventListener('DOMContentLoaded', function() {
            emaId = localStorage.getItem('emaId');
            if (!emaId) { window.location.href = 'index.html'; return; }

            const hasVisited = localStorage.getItem('emaHasVisited');
            welcomeBanner.style.display = hasVisited ? 'none' : 'flex';

            loadUserData();
        });

        // Event Listeners
        getStartedBtn.addEventListener('click', () => { localStorage.setItem('emaHasVisited', 'true'); welcomeBanner.style.display = 'none'; });
        editProfileBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditProfileModal(); });
        closeModalBtn.addEventListener('click', (e) => { e.stopPropagation(); editProfileModal.classList.remove('active'); });
        editProfileForm.addEventListener('submit', (e) => { e.preventDefault(); saveProfileChanges(); });
        agentStatusBtn.addEventListener('click', (e) => { e.stopPropagation(); window.location.href = 'agent.html'; });
        mapToggleBtn.addEventListener('click', toggleMapLayer);
        userLocationBtn.addEventListener('click', centerMapOnUser);
        infoBtn.addEventListener('click', () => infoModal.classList.add('active'));
        closeInfoModalBtn.addEventListener('click', () => infoModal.classList.remove('active'));
        otherBtn.addEventListener('click', () => window.location.href = 'other.html');
        reportFormClose.addEventListener('click', closeReportForm);
        successCloseBtn.addEventListener('click', () => { successModal.classList.remove('active'); location.reload(); });
        reportDetailsClose.addEventListener('click', () => reportDetailsModal.classList.remove('active'));
        retryLocationBtn.addEventListener('click', () => { locationErrorModal.classList.remove('active'); initializeMap(); });
        openSettingsBtn.addEventListener('click', () => {
            if (navigator.userAgent.includes('Android')) window.location.href = 'app-settings:location';
            else if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) window.location.href = 'app-settings:root=LOCATION_SERVICES';
            else window.open('https://support.google.com/?p=android_location_settings');
        });
        userAvatar.addEventListener('click', (e) => { e.stopPropagation(); profilePictureInput.click(); });
        profilePictureInput.addEventListener('change', handleProfilePictureChange);
        logoutBtn.addEventListener('click', () => logoutModal.classList.add('active'));
        logoutCancelBtn.addEventListener('click', () => logoutModal.classList.remove('active'));
        logoutConfirmBtn.addEventListener('click', handleLogout);
        deleteAccountBtn.addEventListener('click', handleDeleteAccount);
        statsBtn.addEventListener('click', () => { loadUserStats(); statsModal.classList.add('active'); });
        closeStatsModalBtn.addEventListener('click', () => statsModal.classList.remove('active'));
        messageCloseBtn.addEventListener('click', () => messageModal.classList.remove('active'));

        // Report Form Listeners
        document.getElementById('sightingOption').addEventListener('click', () => { reportData.type = 'sighting'; showSlide('elephantTypeSlide'); });
        document.getElementById('accidentOption').addEventListener('click', () => { reportData.type = 'accident'; showSlide('elephantTypeSlide'); });
        document.getElementById('elephantOption').addEventListener('click', () => selectElephantType('elephant'));
        document.getElementById('tuskerOption').addEventListener('click', () => selectElephantType('tusker'));
        document.getElementById('countCorrect').addEventListener('click', () => { reportData.count = parseInt(document.getElementById('countDisplay').textContent) || 0; showSlide('imagesSlide'); });
        document.getElementById('continueToDescription').addEventListener('click', () => showSlide('descriptionSlide'));
        document.getElementById('submitReportBtn').addEventListener('click', submitReport);
        document.getElementById('injuredHumansOption').addEventListener('click', () => selectInjury('humans'));
        document.getElementById('injuredElephantsOption').addEventListener('click', () => selectInjury('elephants'));
        document.getElementById('medicalYesOption').addEventListener('click', () => selectMedicalHelp(true));
        document.getElementById('medicalNoOption').addEventListener('click', () => selectMedicalHelp(false));
        document.getElementById('callReporterBtn').addEventListener('click', () => { const phone = document.getElementById('reporterPhoneValue').textContent; window.location.href = `tel:${phone}`; });
        document.getElementById('downloadImagesBtn').addEventListener('click', downloadReportImages);

        // Dial Pad Listeners
        document.querySelectorAll('.dial-button').forEach(button => {
            button.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const display = document.getElementById('countDisplay');
                if (value === '#') display.textContent = display.textContent.slice(0, -1);
                else if (value === '*') display.textContent = '0';
                else display.textContent = (display.textContent === '0') ? value : display.textContent + value;
            });
        });
        document.getElementById('countBackspace').addEventListener('click', () => {
            const display = document.getElementById('countDisplay');
            display.textContent = display.textContent.slice(0, -1);
        });

        // Image Upload Listeners
        for (let i = 1; i <= 4; i++) {
            const uploadBox = document.getElementById(`imageUpload${i}`);
            const input = document.getElementById(`reportImageInput${i}`);
            uploadBox.addEventListener('click', () => input.click());
            input.addEventListener('change', (e) => handleImageUpload(e, i));
        }

        // Core Functions
        function loadUserData() {
            loader.style.display = 'flex';
            database.ref('users/' + emaId).once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) { showMessage('Error', 'User data not found. Please login again.'); window.location.href = 'index.html'; return; }
                    userData = snapshot.val();
                    userName.textContent = userData.fullName;
                    userEmaId.textContent = emaId;
                    userAvatar.src = userData.profilePicture || 'https://picsum.photos/seed/emauser/100/100.jpg';
                    initializeMap();
                })
                .catch((error) => { console.error('Error loading user data:', error); showMessage('Error', 'Error loading user data. Please try again.'); window.location.href = 'index.html'; })
                .finally(() => loader.style.display = 'none');
        }

        function initializeMap() {
            if (!navigator.geolocation) { showLocationError(); return; }
            navigator.geolocation.getCurrentPosition(setupMap, (error) => { if (error.code === error.PERMISSION_DENIED) showLocationError(); else setupMap(null); }, { enableHighAccuracy: true, timeout: 10000 });
        }

        function setupMap(position) {
            map = L.map('map', { center: position ? [position.coords.latitude, position.coords.longitude] : [7.8731, 80.7718], zoom: 8, zoomControl: false, preferCanvas: true });
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '', maxZoom: 19 }).addTo(map);
            esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '', maxZoom: 19 });

            map.on('dblclick', (e) => { reportLocation = e.latlng; openReportForm(); });

            if (position) {
                const lat = position.coords.latitude, lng = position.coords.longitude;
                if (userLocationMarker) map.removeLayer(userLocationMarker);
                userLocationMarker = L.marker([lat, lng], { icon: L.divIcon({ className: 'user-location-marker', iconSize: [20, 20], iconAnchor: [10, 10] }) }).addTo(map);
                navigator.geolocation.watchPosition((newPosition) => { if (userLocationMarker) userLocationMarker.setLatLng([newPosition.coords.latitude, newPosition.coords.longitude]); }, (error) => console.error('Error watching position:', error), { enableHighAccuracy: true });
            }
            loadReports();
        }

        function showLocationError() { locationErrorModal.classList.add('active'); }

        function loadReports() {
            const twelveHoursAgo = new Date(); twelveHoursAgo.setHours(twelveHoursAgo.getHours() - 12);
            database.ref('reports').orderByChild('timestamp').startAt(twelveHoursAgo.toISOString()).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const report = childSnapshot.val();
                            const reportId = childSnapshot.key;
                            addReportMarker(reportId, report);
                        });
                    }
                })
                .catch((error) => console.error('Error loading reports:', error));
        }

        function addReportMarker(reportId, report) {
            if (!report.location) return;
            let markerClass = 'report-marker';
            if (report.type === 'sighting') markerClass += ' sighting-marker';
            else if (report.type === 'accident') markerClass += report.medicalHelpNeeded ? ' accident-medical-marker' : ' accident-marker';
            const marker = L.marker([report.location.lat, report.location.lng], { icon: L.divIcon({ className: markerClass, iconSize: [20, 20], iconAnchor: [10, 10] }) }).addTo(map);
            marker.on('click', () => showReportDetails(reportId, report));
            reportMarkers.push({ id: reportId, marker: marker, timestamp: new Date(report.timestamp) });
        }

        function showReportDetails(reportId, report) {
            document.getElementById('reportTypeValue').textContent = report.type === 'sighting' ? 'Elephant Sighting' : 'Elephant Accident';
            document.getElementById('reportDateTimeValue').textContent = new Date(report.timestamp).toLocaleString();
            document.getElementById('reportLocationValue').textContent = `Lat: ${report.location.lat.toFixed(6)}, Lng: ${report.location.lng.toFixed(6)}`;
            document.getElementById('reportElephantTypeValue').textContent = report.elephantType === 'elephant' ? 'Elephant' : 'Tusker';
            document.getElementById('reportCountValue').textContent = report.count;
            document.getElementById('reportDescriptionValue').textContent = report.description || 'No description provided';
            database.ref('users/' + report.reporterId).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const reporter = snapshot.val();
                    document.getElementById('reporterNameValue').textContent = reporter.fullName;
                    document.getElementById('reporterPhoneValue').textContent = reporter.phone;
                }
            }).catch((error) => console.error('Error loading reporter info:', error));

            if (report.type === 'accident') {
                document.getElementById('accidentSpecificInfo').style.display = 'block';
                let injuriesText = 'None';
                if (report.injuries.includes('humans') && report.injuries.includes('elephants')) injuriesText = 'Humans and Elephants';
                else if (report.injuries.includes('humans')) injuriesText = 'Humans';
                else if (report.injuries.includes('elephants')) injuriesText = 'Elephants';
                document.getElementById('reportInjuriesValue').textContent = injuriesText;
                document.getElementById('reportMedicalHelpValue').textContent = report.medicalHelpNeeded ? 'Yes' : 'No';
            } else {
                document.getElementById('accidentSpecificInfo').style.display = 'none';
            }

            const imagesContainer = document.getElementById('reportImagesContainer');
            imagesContainer.innerHTML = '';
            if (report.images && report.images.length > 0) {
                report.images.forEach((imageBase64, index) => {
                    if (imageBase64) {
                        const img = document.createElement('img');
                        img.src = imageBase64;
                        img.className = 'report-image';
                        img.alt = `Report image ${index + 1}`;
                        imagesContainer.appendChild(img);
                    }
                });
            } else {
                imagesContainer.style.display = 'none';
            }
            reportDetailsModal.classList.add('active');
        }

        function toggleMapLayer() {
            if (currentMapLayer === 'osm') { map.removeLayer(osmLayer); map.addLayer(esriLayer); currentMapLayer = 'esri'; }
            else { map.removeLayer(esriLayer); map.addLayer(osmLayer); currentMapLayer = 'osm'; }
        }

        function centerMapOnUser() {
            if (!navigator.geolocation) { showLocationError(); return; }
            loader.style.display = 'flex';
            navigator.geolocation.getCurrentPosition(
                (position) => { map.setView([position.coords.latitude, position.coords.longitude], 14); loader.style.display = 'none'; },
                (error) => { console.error('Error getting location:', error); loader.style.display = 'none'; showLocationError(); },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function openEditProfileModal() {
            if (!userData) return;
            document.getElementById('editFullName').value = userData.fullName;
            document.getElementById('editPhone').value = userData.phone;
            document.getElementById('editDistrict').value = userData.district;
            document.getElementById('editEmail').value = userData.email;
            document.querySelectorAll('.error-text').forEach(el => el.style.display = 'none');
            editProfileModal.classList.add('active');
        }

        function saveProfileChanges() {
            const fullName = document.getElementById('editFullName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const district = document.getElementById('editDistrict').value;
            const email = document.getElementById('editEmail').value.trim();
            let isValid = true;
            if (!fullName) { showError('editFullNameError', 'Please enter your full name'); isValid = false; } else hideError('editFullNameError');
            if (!phone) { showError('editPhoneError', 'Please enter your phone number'); isValid = false; } else if (!/^[0-9]{10}$/.test(phone)) { showError('editPhoneError', 'Please enter a valid 10-digit phone number'); isValid = false; } else hideError('editPhoneError');
            if (!district) { showError('editDistrictError', 'Please select your district'); isValid = false; } else hideError('editDistrictError');
            if (!email) { showError('editEmailError', 'Please enter your email'); isValid = false; } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showError('editEmailError', 'Please enter a valid email address'); isValid = false; } else hideError('editEmailError');
            if (!isValid) return;

            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = true; saveBtn.textContent = 'Saving...';
            userData.fullName = fullName; userData.phone = phone; userData.district = district; userData.email = email;
            database.ref('users/' + emaId).set(userData)
                .then(() => { userName.textContent = fullName; editProfileModal.classList.remove('active'); showMessage('Success', 'Profile updated successfully!'); })
                .catch((error) => { console.error('Error updating profile:', error); showMessage('Error', 'Error updating profile. Please try again.'); })
                .finally(() => { saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; });
        }

        function handleProfilePictureChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            compressImage(file, 0.2)
                .then(compressedImage => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;
                        userAvatar.src = base64;
                        userData.profilePicture = base64;
                        database.ref('users/' + emaId).update({ profilePicture: base64 })
                            .then(() => showMessage('Success', 'Profile picture updated successfully!'))
                            .catch((error) => { console.error('Error updating profile picture:', error); showMessage('Error', 'Error updating profile picture. Please try again.'); });
                    };
                    reader.readAsDataURL(compressedImage);
                })
                .catch(error => { console.error('Error compressing image:', error); showMessage('Error', 'Error processing image. Please try again.'); });
        }

        function openReportForm() {
            reportData = { type: '', elephantType: '', count: 0, images: [], description: '', injuries: [], medicalHelpNeeded: false, location: reportLocation, timestamp: null, reporterId: emaId };
            document.getElementById('countDisplay').textContent = '0';
            document.getElementById('reportDescription').value = '';
            for (let i = 1; i <= 4; i++) {
                const uploadBox = document.getElementById(`imageUpload${i}`);
                uploadBox.classList.remove('has-image');
                uploadBox.innerHTML = `<i class="fas fa-camera"></i><div>Image ${i}</div>`;
            }
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            reportFormContainer.classList.add('active');
            showSlide('reportTypeSlide');
        }

        function closeReportForm() { reportFormContainer.classList.remove('active'); }

        function showSlide(slideId) {
            document.querySelectorAll('.report-slide').forEach(slide => slide.classList.remove('active'));
            document.getElementById(slideId).classList.add('active');
        }

        function selectElephantType(type) {
            reportData.elephantType = type;
            document.querySelectorAll('#elephantTypeSlide .radio-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(type + 'Option').classList.add('selected');
            setTimeout(() => { showSlide(reportData.type === 'accident' ? 'injurySlide' : 'countSlide'); }, 300);
        }

        function selectInjury(type) {
            if (!reportData.injuries.includes(type)) reportData.injuries.push(type);
            document.querySelectorAll('#injurySlide .radio-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('injured' + type.charAt(0).toUpperCase() + type.slice(1) + 'Option').classList.add('selected');
            setTimeout(() => showSlide('medicalHelpSlide'), 300);
        }

        function selectMedicalHelp(isNeeded) {
            reportData.medicalHelpNeeded = isNeeded;
            document.querySelectorAll('#medicalHelpSlide .radio-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('medical' + (isNeeded ? 'Yes' : 'No') + 'Option').classList.add('selected');
            setTimeout(() => showSlide('countSlide'), 300);
        }

        function handleImageUpload(e, index) {
            const file = e.target.files[0];
            if (!file) return;
            compressImage(file, 0.1)
                .then(compressedImage => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;
                        const uploadBox = document.getElementById(`imageUpload${index}`);
                        uploadBox.classList.add('has-image');
                        uploadBox.innerHTML = `<img src="${base64}" class="image-preview" alt="Image ${index}"><div class="image-remove" data-index="${index-1}"><span class="material-symbols-outlined">close</span></div>`;
                        reportData.images[index - 1] = base64;
                        uploadBox.querySelector('.image-remove').addEventListener('click', (event) => {
                            event.stopPropagation();
                            const i = parseInt(event.currentTarget.closest('.image-remove').getAttribute('data-index')) + 1;
                            const box = document.getElementById(`imageUpload${i}`);
                            box.classList.remove('has-image');
                            box.innerHTML = `<i class="fas fa-camera"></i><div>Image ${i}</div>`;
                            reportData.images[i - 1] = null;
                            box.addEventListener('click', () => document.getElementById(`reportImageInput${i}`).click());
                        });
                    };
                    reader.readAsDataURL(compressedImage);
                })
                .catch(error => { console.error('Error compressing image:', error); showMessage('Error', 'Error processing image. Please try again.'); });
        }

        function submitReport() {
            reportData.description = document.getElementById('reportDescription').value;
            reportData.timestamp = new Date().toISOString();
            loader.style.display = 'flex';
            const reportId = generateReportId(reportData.type);
            database.ref('reports/' + reportId).set(reportData)
                .then(() => database.ref('users/' + emaId + '/reports/' + reportId).set({ reportId: reportId, timestamp: reportData.timestamp }))
                .then(() => { loader.style.display = 'none'; successModal.classList.add('active'); closeReportForm(); })
                .catch((error) => { console.error('Error saving report:', error); loader.style.display = 'none'; showMessage('Error', 'Error submitting report. Please try again.'); });
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        function handleDeleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
            loader.style.display = 'flex';
            const userReportsRef = database.ref('users/' + emaId + '/reports');
            userReportsRef.once('value')
                .then((snapshot) => {
                    const reportsToDelete = snapshot.val() || {};
                    const deletePromises = Object.keys(reportsToDelete).map(reportId => database.ref('reports/' + reportId).remove());
                    return Promise.all(deletePromises);
                })
                .then(() => database.ref('users/' + emaId).remove())
                .then(() => { loader.style.display = 'none'; localStorage.clear(); window.location.href = 'index.html'; })
                .catch((error) => { console.error('Error deleting account:', error); loader.style.display = 'none'; showMessage('Error', 'Error deleting account. Please try again.'); });
        }

        function loadUserStats() {
            document.getElementById('statsUserName').textContent = userData.fullName;
            document.getElementById('statsEmaId').textContent = emaId;
            const reportsListContainer = document.getElementById('reportsListContainer');
            reportsListContainer.innerHTML = '';
            const userReportsRef = database.ref('users/' + emaId + '/reports');
            userReportsRef.once('value')
                .then((snapshot) => {
                    const reports = snapshot.val() || {};
                    const reportIds = Object.keys(reports);
                    document.getElementById('statsTotalReports').textContent = reportIds.length;
                    if (reportIds.length === 0) {
                        reportsListContainer.innerHTML = '<p class="info-item-text">No reports submitted yet.</p>';
                        return;
                    }
                    reportIds.forEach(reportId => {
                        const reportItem = document.createElement('div');
                        reportItem.className = 'report-item';
                        reportItem.innerHTML = `
                            <div class="report-item-type">Report ID: ${reportId}</div>
                            <div class="report-item-date">${new Date(reports[reportId].timestamp).toLocaleString()}</div>
                            <div class="delete-report-btn" data-report-id="${reportId}"><span class="material-symbols-outlined">delete</span></div>
                        `;
                        reportsListContainer.appendChild(reportItem);
                    });
                    document.querySelectorAll('.delete-report-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const reportIdToDelete = btn.getAttribute('data-report-id');
                            if (confirm('Are you sure you want to delete this report?')) {
                                loader.style.display = 'flex';
                                database.ref('reports/' + reportIdToDelete).remove()
                                    .then(() => database.ref('users/' + emaId + '/reports/' + reportIdToDelete).remove())
                                    .then(() => { loader.style.display = 'none'; loadUserStats(); showMessage('Success', 'Report deleted successfully.'); })
                                    .catch((error) => { console.error('Error deleting report:', error); loader.style.display = 'none'; showMessage('Error', 'Error deleting report. Please try again.'); });
                            }
                        });
                    });
                })
                .catch((error) => { console.error('Error loading user stats:', error); showMessage('Error', 'Could not load statistics.'); });
        }

        function downloadReportImages() {
            const images = document.querySelectorAll('#reportImagesContainer .report-image');
            images.forEach((img, index) => {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `report_image_${index + 1}.jpg`;
                link.click();
            });
        }

        function generateReportId(type) {
            const prefix = type === 'sighting' ? 'S' : 'A';
            const randomNum = Math.floor(100000000000 + Math.random() * 900000000);
            return randomNum + '-' + prefix;
        }

        function compressImage(file, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let { width, height } = img;
                        const maxDimension = 800;
                        if (width > height) { if (width > maxDimension) { height *= maxDimension / width; width = maxDimension; } }
                        else { if (height > maxDimension) { width *= maxDimension / height; height = maxDimension; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => resolve(blob), 'image/jpeg', quality);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function showMessage(title, text) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageModal.classList.add('active');
        }

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
            document.getElementById(elementId).style.display = 'block';
        }
        function hideError(elementId) { document.getElementById(elementId).style.display = 'none'; }
    </script>
</body>
</html>
