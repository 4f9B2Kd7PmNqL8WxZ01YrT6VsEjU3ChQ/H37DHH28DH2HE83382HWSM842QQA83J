<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA - Create Account</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7f4;
        }
        
        .loader-container {
            backdrop-filter: blur(5px);
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4CAF50;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-text {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .input-field {
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }
        
        .image-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e5e7eb;
        }
        
        .popup {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center">
            <button id="backBtn" class="mr-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold text-gray-800">Create Account</h1>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-md mx-auto px-4 py-6">
        <p class="text-gray-600 text-center mb-6">Create a new account to get started and enjoy seamless access to our features.</p>
        
        <!-- Registration Form -->
        <form id="registrationForm" class="space-y-4">
            <!-- Profile Picture -->
            <div class="flex flex-col items-center mb-6">
                <div id="imagePreview" class="mb-3">
                    <div class="w-32 h-32 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                </div>
                <label for="profilePicture" class="px-6 py-2 bg-green-600 text-white rounded-full cursor-pointer hover:bg-green-700 transition-colors">
                    Add Photo
                </label>
                <input type="file" id="profilePicture" accept="image/*" class="hidden">
            </div>
            
            <!-- Name Field -->
            <div>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </div>
                    <input type="text" id="name" name="name" placeholder="Name" class="input-field w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                </div>
                <div id="nameError" class="error-text hidden">Name must be at least 5 characters long</div>
            </div>
            
            <!-- Email Field -->
            <div>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <input type="email" id="email" name="email" placeholder="Email Address" class="input-field w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                </div>
                <div id="emailError" class="error-text hidden">Please use a valid email from gmail, icloud, hotmail, outlook, or yahoo</div>
            </div>
            
            <!-- Phone Number Field -->
            <div>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                    </div>
                    <input type="tel" id="phone" name="phone" placeholder="Phone Number" class="input-field w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500">
                </div>
                <div id="phoneError" class="error-text hidden">Please enter a valid Sri Lankan phone number (07XXXXXXXX)</div>
            </div>
            
            <!-- Province Field -->
            <div>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <select id="province" name="province" class="input-field w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 appearance-none">
                        <option value="">Select Province</option>
                        <option value="western">Western Province</option>
                        <option value="central">Central Province</option>
                        <option value="southern">Southern Province</option>
                        <option value="northern">Northern Province</option>
                        <option value="eastern">Eastern Province</option>
                        <option value="northwestern">North Western Province</option>
                        <option value="northcentral">North Central Province</option>
                        <option value="uvaprovince">Uva Province</option>
                        <option value="sabaragamuwa">Sabaragamuwa Province</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
                <div id="provinceError" class="error-text hidden">Please select a province</div>
            </div>
            
            <!-- District Field -->
            <div>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <select id="district" name="district" class="input-field w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500 appearance-none" disabled>
                        <option value="">Select District</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>
                <div id="districtError" class="error-text hidden">Please select a district</div>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="w-full py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors">
                Create Account
            </button>
        </form>
        
        <!-- Footer -->
        <div class="mt-8 text-center text-sm text-gray-500">
            <p>EMA - Elephant Monitoring App</p>
            <p>&copy; 2025 Aveesha Ninsara Pelawaththa</p>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader-container fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-gray-700">Creating your account...</p>
        </div>
    </div>

    <!-- Success Popup -->
    <div id="successPopup" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <div class="popup bg-white p-6 rounded-lg shadow-lg max-w-sm mx-4 relative z-10">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Account Created Successfully!</h3>
                <p class="text-sm text-gray-600 mb-4">Your EMA ID is: <span id="emaId" class="font-semibold"></span></p>
                <p class="text-sm text-gray-600 mb-1">Make sure to remember this code to avoid problems in the future</p>
                <p class="text-sm text-gray-600 mb-4">අනාගතයේදී ගැටළු වළක්වා ගැනීම සඳහා මෙම කේතය මතක තබා ගැනීමට වග බලා ගන්න.</p>
                <button id="doneBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    Done
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCtIvVHA0Q_iuTIFNanoU8RhV4oC60L_YM",
            authDomain: "emausers-9837a.firebaseapp.com",
            projectId: "emausers-9837a",
            storageBucket: "emausers-9837a.firebasestorage.app",
            messagingSenderId: "418180372006",
            appId: "1:418180372006:web:5534a07888222cdb0a78e7",
            measurementId: "G-TRDREJFMQ9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Districts data for each province
        const districts = {
            western: ["Colombo", "Gampaha", "Kalutara"],
            central: ["Kandy", "Matale", "Nuwara Eliya"],
            southern: ["Galle", "Matara", "Hambantota"],
            northern: ["Jaffna", "Kilinochchi", "Mannar", "Vavuniya", "Mullaitivu"],
            eastern: ["Batticaloa", "Ampara", "Trincomalee"],
            northwestern: ["Kurunegala", "Puttalam"],
            northcentral: ["Anuradhapura", "Polonnaruwa"],
            uvaprovince: ["Badulla", "Monaragala"],
            sabaragamuwa: ["Ratnapura", "Kegalle"]
        };

        // DOM elements
        const profilePictureInput = document.getElementById('profilePicture');
        const imagePreview = document.getElementById('imagePreview');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const registrationForm = document.getElementById('registrationForm');
        const loader = document.getElementById('loader');
        const successPopup = document.getElementById('successPopup');
        const emaIdSpan = document.getElementById('emaId');
        const doneBtn = document.getElementById('doneBtn');
        const backBtn = document.getElementById('backBtn');

        // Error elements
        const nameError = document.getElementById('nameError');
        const emailError = document.getElementById('emailError');
        const phoneError = document.getElementById('phoneError');
        const provinceError = document.getElementById('provinceError');
        const districtError = document.getElementById('districtError');

        // Image preview
        let compressedImageData = null;
        profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        // Compress image
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Calculate new dimensions to keep aspect ratio but reduce size
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 300;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Try to get around 50KB by adjusting quality
                        let quality = 0.7;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // If still too large, reduce quality
                        while (dataUrl.length > 50000 && quality > 0.1) {
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        
                        compressedImageData = dataUrl;
                        
                        // Update preview
                        imagePreview.innerHTML = `<img src="${dataUrl}" alt="Profile Picture" class="image-preview">`;
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Province change event
        provinceSelect.addEventListener('change', function() {
            const selectedProvince = this.value;
            districtSelect.innerHTML = '<option value="">Select District</option>';
            
            if (selectedProvince && districts[selectedProvince]) {
                districtSelect.disabled = false;
                districts[selectedProvince].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.toLowerCase().replace(/\s+/g, '-');
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            } else {
                districtSelect.disabled = true;
            }
        });

        // Form validation
        function validateName() {
            const name = nameInput.value.trim();
            if (name.length < 5) {
                nameError.classList.remove('hidden');
                return false;
            } else {
                nameError.classList.add('hidden');
                return true;
            }
        }

        function validateEmail() {
            const email = emailInput.value.trim();
            const allowedDomains = ['gmail.com', 'icloud.com', 'hotmail.com', 'outlook.com', 'yahoo.com'];
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailRegex.test(email)) {
                emailError.classList.remove('hidden');
                return false;
            }
            
            const domain = email.split('@')[1].toLowerCase();
            if (!allowedDomains.includes(domain)) {
                emailError.classList.remove('hidden');
                return false;
            }
            
            emailError.classList.add('hidden');
            return true;
        }

        function validatePhone() {
            const phone = phoneInput.value.trim();
            const phoneRegex = /^07[0-9]{8}$/;
            
            if (!phoneRegex.test(phone)) {
                phoneError.classList.remove('hidden');
                return false;
            }
            
            phoneError.classList.add('hidden');
            return true;
        }

        function validateProvince() {
            if (!provinceSelect.value) {
                provinceError.classList.remove('hidden');
                return false;
            }
            
            provinceError.classList.add('hidden');
            return true;
        }

        function validateDistrict() {
            if (!districtSelect.value) {
                districtError.classList.remove('hidden');
                return false;
            }
            
            districtError.classList.add('hidden');
            return true;
        }

        // Add event listeners for real-time validation
        nameInput.addEventListener('blur', validateName);
        emailInput.addEventListener('blur', validateEmail);
        phoneInput.addEventListener('blur', validatePhone);
        provinceSelect.addEventListener('change', validateProvince);
        districtSelect.addEventListener('change', validateDistrict);

        // Generate random EMA ID
        function generateEmaId() {
            const randomDigits = Math.floor(100000 + Math.random() * 900000);
            return `${randomDigits}-E`;
        }

        // Check if EMA ID already exists
        async function checkEmaIdExists(emaId) {
            const snapshot = await database.ref('users').orderByKey().equalTo(emaId).once('value');
            return snapshot.exists();
        }

        // Get unique EMA ID
        async function getUniqueEmaId() {
            let emaId = generateEmaId();
            let exists = await checkEmaIdExists(emaId);
            
            while (exists) {
                emaId = generateEmaId();
                exists = await checkEmaIdExists(emaId);
            }
            
            return emaId;
        }

        // Form submission
        registrationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate all fields
            const isNameValid = validateName();
            const isEmailValid = validateEmail();
            const isPhoneValid = validatePhone();
            const isProvinceValid = validateProvince();
            const isDistrictValid = validateDistrict();
            
            if (!isNameValid || !isEmailValid || !isPhoneValid || !isProvinceValid || !isDistrictValid) {
                return;
            }
            
            // Show loader
            loader.classList.remove('hidden');
            
            try {
                // Get unique EMA ID
                const emaId = await getUniqueEmaId();
                
                // Prepare user data
                const userData = {
                    name: nameInput.value.trim(),
                    email: emailInput.value.trim(),
                    phone: phoneInput.value.trim(),
                    province: provinceSelect.value,
                    district: districtSelect.value,
                    profilePicture: compressedImageData || null,
                    emaId: emaId,
                    createdAt: new Date().toISOString()
                };
                
                // Save to Firebase
                await database.ref(`users/${emaId}`).set(userData);
                
                // Hide loader
                loader.classList.add('hidden');
                
                // Show success popup
                emaIdSpan.textContent = emaId;
                successPopup.classList.remove('hidden');
                
                // Save EMA ID to localStorage
                localStorage.setItem('emaId', emaId);
                
            } catch (error) {
                console.error('Error creating account:', error);
                loader.classList.add('hidden');
                alert('An error occurred while creating your account. Please try again.');
            }
        });

        // Done button click
        doneBtn.addEventListener('click', function() {
            successPopup.classList.add('hidden');
            window.location.href = 'home.html';
        });

        // Back button click
        backBtn.addEventListener('click', function() {
            window.history.back();
        });
    </script>
</body>
</html>
